#!/usr/bin/env php
<?php

namespace Qafoo\Bsoad;

require __DIR__ . '/../main/Qafoo/Bsoad/bootstrap.php';

set_error_handler( function ( $type, $message, $file, $line )
    {
        if ( error_reporting() === 0 ) return false;
        throw new \Exception( $message );
    }
);

set_exception_handler( function ( \Exception $exception )
    {
        fwrite( STDERR, $exception . PHP_EOL );
        exit( 1 );
    }
);

$reader = new Reader\Tcpdump(
    new Sorter\Basic(
        new ParserFactory\Http(
            new Writer\Dispatcher( array(
                new Writer\Filter(
                    new Writer\Json( STDOUT ),
                    array(
                        'path' => array(
                            '(\\.tpl$)',
                            '(\\.(?:png|jpe?g)$)',
                            '(\\.(?:js|css)$)',
                        ),
                    )
                ),
                new Writer\Debug( STDERR ),
            ) )
        )
    )
);

$reader->process( STDIN );

